---
title: "InSeason_Projections_TE"
author: "Jack DePree"
date: "2024-01-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Within Season Projections

##Contextualization
Each week adds more data that can be used to predict the future; it is assumed that the more data we have, then the more accurate our predictions will be. The data will be centered around discovering three aspects: "individual ability" (stable metrics of performance and efficiency), "situation" (a combination of both opportunity and opposition), "noise reduction" (unstable metrics of luck and unfortune).  Some variables will be unstable and others will be stable. Is there a point where a small sample of data is able to predict the future# If not, then does that mean there is a way we can leverage the unpredictability to outsmart other bettors#

##Reasoning
Using unstable variables as confounding variables, we can adjust the stable variables for more predictive validity. There should also be a point within a season where the amount of usable data passes the threshold of profitability, meaning that we finally have enough data to accurately predict the future: maybe two or three weeks. Furthermore, using the most recent weeks can be more useful than using the entire season to-date, meaning we can add weights to the most recent weeks' data to better predict the future. 

##Scientiic Questions
1. Which variables are highly associated with fantasy points? (Association)
2. Are there variables that are stable (from week to week, or for the next series of weeks) for Tight Ends? (Association)
3. Are there variables that are unstable (from week to week, or for the next series of weeks) for Tight Ends? (Association)
4. Can we make composites of variables to better synthesize the data for prediction, like "individual ability," "situation," "noise reduction?" (PCA)
5. Can we select specific past data (from the past 2, 3, 4 weeks) to better synthesize the data for prediction? (Prediction)

##Methodology
1. Create a df where each week is stacked upon one another for an association test. Compare each variable with both the player's given week's points and the player's total seasonal points.
2. Create a df with each week alongside each other week, for a week-to-week association test. Create summary statistics of each variable, sort by lowest variability. Create correlations between each variable of their past and future samples, sort by highest correlation. 
3. Create a df with each week alongside each other week, for a week-to-week association test. Create summary statistics of each variable, sort by highest variability. Create correlations between each variable of their past and future samples, sort by lowest correlation.
4. Use cluster analysis and model making to form composites of the previously selected variables.
5. Create multiple dfs where the past and future weeks have been averaged in varied ways using weights and recency bias to assess the most predictable weeks and their arrangements.

#Data Collection
```{r}
library(dplyr)
library(tidyverse)
library(corrplot)

wk1_23 <- read.csv("2023_wk1_flex_stats.csv")
wk2_23 <- read.csv("2023_wk2_flex_stats.csv")
wk3_23 <- read.csv("2023_wk3_flex_stats.csv")
wk4_23 <- read.csv("2023_wk4_flex_stats.csv")
wk5_23 <- read.csv("2023_wk5_flex_stats.csv")
wk6_23 <- read.csv("2023_wk6_flex_stats.csv")
wk7_23 <- read.csv("2023_wk7_flex_stats.csv")
wk8_23 <- read.csv("2023_wk8_flex_stats.csv")
wk9_23 <- read.csv("2023_wk9_flex_stats.csv")
wk10_23 <- read.csv("2023_wk10_flex_stats.csv")
wk11_23 <- read.csv("2023_wk11_flex_stats.csv")
wk12_23 <- read.csv("2023_wk12_flex_stats.csv")
wk13_23 <- read.csv("2023_wk13_flex_stats.csv")
wk14_23 <- read.csv("2023_wk14_flex_stats.csv")
wk15_23 <- read.csv("2023_wk15_flex_stats.csv")
wk16_23 <- read.csv("2023_wk16_flex_stats.csv")
wk17_23 <- read.csv("2023_wk17_flex_stats.csv")
total_23 <- read.csv("2023_total_flex_stats.csv")

wk1_22 <- read.csv("2022_wk1_flex_stats.csv")
wk2_22 <- read.csv("2023_wk2_flex_stats.csv")
wk3_22 <- read.csv("2022_wk3_flex_stats.csv")
wk4_22 <- read.csv("2022_wk4_flex_stats.csv")
wk5_22 <- read.csv("2022_wk5_flex_stats.csv")
wk6_22 <- read.csv("2022_wk6_flex_stats.csv")
wk7_22 <- read.csv("2022_wk7_flex_stats.csv")
wk8_22 <- read.csv("2022_wk8_flex_stats.csv")
wk9_22 <- read.csv("2022_wk9_flex_stats.csv")
wk10_22 <- read.csv("2022_wk10_flex_stats.csv")
wk11_22 <- read.csv("2022_wk11_flex_stats.csv")
wk12_22 <- read.csv("2022_wk12_flex_stats.csv")
wk13_22 <- read.csv("2022_wk13_flex_stats.csv")
wk14_22 <- read.csv("2022_wk14_flex_stats.csv")
wk15_22 <- read.csv("2022_wk15_flex_stats.csv")
wk16_22 <- read.csv("2022_wk16_flex_stats.csv")
wk17_22 <- read.csv("2022_wk17_flex_stats.csv")
total_22 <- read.csv("2022_total_flex_stats.csv")

glimpse(total_22)
```

#Data Transformation
```{r}
#separate()
#mutate()
#transmute()
#select()
#relocate()
#na.omit()
total_23 <- select(total_23, c(player, fantasyPts))
total_22 <- select(total_22, c(player, fantasyPts))
```

```{r}
big_23 <- rbind(wk1_23,wk2_23,wk3_23,wk4_23,wk5_23,wk6_23,wk7_23,wk8_23,wk9_23,wk10_23,wk11_23,wk12_23,wk13_23,wk14_23,wk15_23,wk16_23,wk17_23)
big_23 <- merge(big_23, total_23, by="player", all=T, suffixes=c(".x", ".y"))

big_22 <- rbind(wk1_22,wk2_22,wk3_22,wk4_22,wk5_22,wk6_22,wk7_22,wk8_22,wk9_22,wk10_22,wk11_22,wk12_22,wk13_22,wk14_22,wk15_22,wk16_22,wk17_22)
big_22 <- merge(big_22, total_22, by="player", all=T, suffixes=c(".x", ".y"))
```

```{r}
big_association <- rbind(big_23, big_22)
big_association <- big_association %>% 
  filter(position=="TE") %>%
  select(-c(player, team, games, position)) %>%
  na.omit()
big_association <- subset(big_association, recTarg>0)
glimpse(big_association)
```

```{r}

```

#Data Analysis

Calculating the correlation of each variable to both the current week's fatnasy points and the year's total fantasy points.
```{r}
cor.x <- as.matrix(round(cor(big_association, big_association$fantasyPts.x, use="complete.obs"), 3))
cor.y <- as.matrix(round(cor(big_association, big_association$fantasyPts.y, use="complete.obs"), 3))
cor.x.index <- which(cor.x>.1 | cor.x< (-.1))
cor.y.index <- which(cor.y>.1 | cor.y< (-.1))
cor.x.index <- cor.x.index[! cor.x.index %in% c(47,48,49)]
cor.y.index <- cor.y.index[! cor.y.index %in% c(47,48,49)]
head(cor.y, 20)
```

Calculating the coefficient of variation for each variable over all weeks.
```{r}
cv <- function(x) {
  m <- mean(x)
  var <- var(x)
  cv <- var/m
  return(cv)
}
```

```{r}
var.x <- as.matrix(round(apply(big_association[,cor.x.index], 2, cv), 3))
var.y <- as.matrix(round(apply(big_association[,cor.y.index], 2, cv), 3))
var.x.stable.index <- which(var.x<20)
var.x.unstable.index <- which(var.x>20)
var.y.stable.index <- which(var.y<20)
var.y.unstable.index <- which(var.y>20)
head(var.x, 20)
```

```{r}
modeller <- function(dat, indep, dep) {
  indep <- colnames(dat[, indep])
  dep <- grep(dep, colnames(dat))
  data <- dat %>% select(c(all_of(indep), dep)) %>% na.omit()
  intercept_only <- lm(dat[,dep] ~ 1, data=data)
  all <- lm(dat[,dep] ~ ., data=data)
  model <- step(intercept_only, direction="forward", scope=formula(all), trace=0)
  summary(model)
}
modeller(dat=big_association,
         indep=cor.y.index,
         dep="fantasyPts.y")
```

```{r}
data <- big_association %>% select(c(all_of(cor.y.index), fantasyPts.y)) %>% na.omit()
intercept_only <- lm(fantasyPts.y ~ 1, data=data)
all <- lm(fantasyPts.y ~ ., data=data)
model <- step(intercept_only, direction="forward", scope=formula(all), trace=0)
summary(model)
```

#Data Visualization

Visualizing Stability
```{r}
#ggplot()
#geom_smooth()
theme_TE <- theme(text=element_text(family="Times New Roman"))
ggplot(big_association, aes(x=recTd40s)) +
  geom_histogram(binwidth=sd(big_association$recTd40s)/2, fill="darkorchid4") +
  labs(title="Distribution of Receiving Touchdowns over 40 Yards (Stable) (TE)", x="Receiving TDs over 40yds per Game", y="")

ggplot(big_association, aes(x=recRec)) +
  geom_histogram(binwidth=sd(big_association$recRec)/2, fill="darkorchid4") +
  labs(title="Distribution of Receiving Receptions (Stable) (TE)", x="Receiving Recs per Game", y="")
      
ggplot(big_association, aes(x=recYds)) +
  geom_histogram(binwidth=sd(big_association$recYds)/2, fill="darkorchid4") +
  labs(title="Distribution of Receiving Yards (Unstable) (TE)", x="Receiving Yards per Game", y="")

ggplot(big_association, aes(x=rzRecTargPct)) +
  geom_histogram(binwidth=sd(big_association$rzRecTargPct)/2, fill="darkorchid4") +
  labs(title="Distribution of Redzone Target% (Unstable) (TE)", x="Receiving Redzone Target% per Game", y="")

```

```{r}
plot <- cor(big_association[,cor.x.index])
corrplot(plot, method="color")
```

```{r}
ggplot(subset(big_association, recTds<3), aes(x=factor(recTds), y=fantasyPts.x)) +
  geom_violin(fill="darkorchid4") +
  labs(title="Receiving Tds and Fantasy Points (TE)", x="Receiving Touchdowns per game", y="Fantasy Points per game")
```

```{r}
ggplot(big_association, aes(x=factor(recTarg), y=fantasyPts.y)) +
  geom_boxplot(fill="darkorchid4") +
  labs(title="Year-End Points by Receiving Targets within a single game (TE)", x="Targets per game", y="Year-End Fantasy Points")

ggplot(big_association, aes(x=factor(rzRecTarg), y=fantasyPts.y)) +
  geom_boxplot(fill="darkorchid4") +
  labs(title="Year-End Points by Redzone Receiving Targets within a single game (TE)", x="Redzone Targets per game", y="Year-End Fantasy Points")

ggplot(big_association, aes(x=factor(rzRecRec), y=fantasyPts.y)) +
  geom_boxplot(fill="darkorchid4") +
  labs(title="Year-End Points by Redzone Receiving Receptions within a single game (TE)", x="Redzone Recpetions per game", y="Year-End Fantasy Points")
```

```{r}
ggplot(big_association, aes(x=recYds, y=fantasyPts.y, color=recTds, alpha=.4)) +
  geom_point() +
  scale_color_gradient2(low="gray", mid="darkorchid", high="darkorchid4")
  labs(title="Year-End Points by Receiving Yards within a single game (TE)", x="Receiving Yards per game", y="Year-End Fantasy Points")
```


#Data Prediction
```{r}

```