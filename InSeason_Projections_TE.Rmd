---
title: "InSeason_Projections_TE"
author: "Jack DePree"
date: "2024-01-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Within Season Projections Tight Ends

## Contextualization
Each week adds more data that can be used to predict the future; it is assumed that the more data we have, then the more accurate our predictions will be. The data will be centered around discovering three aspects: "individual ability" (stable metrics of performance and efficiency), "situation" (a combination of both opportunity and opposition), "noise reduction" (unstable metrics of luck and unfortune).  Some variables will be unstable and others will be stable. Is there a point where a small sample of data is able to predict the future# If not, then does that mean there is a way we can leverage the unpredictability to outsmart other bettors?

## Reasoning
Using unstable variables as confounding variables, we can adjust the stable variables for more predictive validity. There should also be a point within a season where the amount of usable data passes the threshold of profitability, meaning that we finally have enough data to accurately predict the future: maybe two or three weeks. Furthermore, using the most recent weeks can be more useful than using the entire season to-date, meaning we can add weights to the most recent weeks' data to better predict the future. 

## Scientiic Questions
1. Which variables are highly associated with fantasy points? (Association)
2. Are there variables that are stable (from week to week, or for the next series of weeks) for Tight Ends? (Association)
3. Are there variables that are unstable (from week to week, or for the next series of weeks) for Tight Ends? (Association)
4. Can we make composites of variables to better synthesize the data for prediction, like "individual ability," "situation," "noise reduction?" (PCA)
5. Can we select specific past data (from the past 2, 3, 4 weeks) to better synthesize the data for prediction? (Prediction)

## Methodology
1. Create a df where each week is stacked upon one another for an association test. Compare each variable with both the player's given week's points and the player's total seasonal points.
2. Create a df with each week alongside each other week, for a week-to-week association test. Create summary statistics of each variable, sort by lowest variability. Create correlations between each variable of their past and future samples, sort by highest correlation. 
3. Create a df with each week alongside each other week, for a week-to-week association test. Create summary statistics of each variable, sort by highest variability. Create correlations between each variable of their past and future samples, sort by lowest correlation.
4. Use cluster analysis and model making to form composites of the previously selected variables.
5. Create multiple dfs where the past and future weeks have been averaged in varied ways using weights and recency bias to assess the most predictable weeks and their arrangements.

# Data Collection
```{r}
library(dplyr)
library(tidyverse)
library(lsr)
library(corrplot)

wk1_23 <- read.csv("2023_wk1_flex_stats.csv")
wk2_23 <- read.csv("2023_wk2_flex_stats.csv")
wk3_23 <- read.csv("2023_wk3_flex_stats.csv")
wk4_23 <- read.csv("2023_wk4_flex_stats.csv")
wk5_23 <- read.csv("2023_wk5_flex_stats.csv")
wk6_23 <- read.csv("2023_wk6_flex_stats.csv")
wk7_23 <- read.csv("2023_wk7_flex_stats.csv")
wk8_23 <- read.csv("2023_wk8_flex_stats.csv")
wk9_23 <- read.csv("2023_wk9_flex_stats.csv")
wk10_23 <- read.csv("2023_wk10_flex_stats.csv")
wk11_23 <- read.csv("2023_wk11_flex_stats.csv")
wk12_23 <- read.csv("2023_wk12_flex_stats.csv")
wk13_23 <- read.csv("2023_wk13_flex_stats.csv")
wk14_23 <- read.csv("2023_wk14_flex_stats.csv")
wk15_23 <- read.csv("2023_wk15_flex_stats.csv")
wk16_23 <- read.csv("2023_wk16_flex_stats.csv")
wk17_23 <- read.csv("2023_wk17_flex_stats.csv")
total_23 <- read.csv("2023_total_flex_stats.csv")

wk1_22 <- read.csv("2022_wk1_flex_stats.csv")
wk2_22 <- read.csv("2023_wk2_flex_stats.csv")
wk3_22 <- read.csv("2022_wk3_flex_stats.csv")
wk4_22 <- read.csv("2022_wk4_flex_stats.csv")
wk5_22 <- read.csv("2022_wk5_flex_stats.csv")
wk6_22 <- read.csv("2022_wk6_flex_stats.csv")
wk7_22 <- read.csv("2022_wk7_flex_stats.csv")
wk8_22 <- read.csv("2022_wk8_flex_stats.csv")
wk9_22 <- read.csv("2022_wk9_flex_stats.csv")
wk10_22 <- read.csv("2022_wk10_flex_stats.csv")
wk11_22 <- read.csv("2022_wk11_flex_stats.csv")
wk12_22 <- read.csv("2022_wk12_flex_stats.csv")
wk13_22 <- read.csv("2022_wk13_flex_stats.csv")
wk14_22 <- read.csv("2022_wk14_flex_stats.csv")
wk15_22 <- read.csv("2022_wk15_flex_stats.csv")
wk16_22 <- read.csv("2022_wk16_flex_stats.csv")
wk17_22 <- read.csv("2022_wk17_flex_stats.csv")
total_22 <- read.csv("2022_total_flex_stats.csv")

glimpse(total_22)
```

# Data Cleaning
```{r}
wk1_23 <- wk1_23 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk2_23 <- wk2_23 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk3_23 <- wk3_23 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk4_23 <- wk4_23 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk5_23 <- wk5_23 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk6_23 <- wk6_23 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk7_23 <- wk7_23 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk8_23 <- wk8_23 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk9_23 <- wk9_23 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk10_23 <- wk10_23 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk11_23 <- wk11_23 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk12_23 <- wk12_23 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk13_23 <- wk13_23 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk14_23 <- wk14_23 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk15_23 <- wk15_23 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk16_23 <- wk16_23 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk17_23 <- wk17_23 %>% filter(position=="TE") %>% select(-c(team, games, position))

wk1_22 <- wk1_22 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk2_22 <- wk2_22 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk3_22 <- wk3_22 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk4_22 <- wk4_22 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk5_22 <- wk5_22 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk6_22 <- wk6_22 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk7_22 <- wk7_22 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk8_22 <- wk8_22 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk9_22 <- wk9_22 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk10_22 <- wk10_22 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk11_22 <- wk11_22 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk12_22 <- wk12_22 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk13_22 <- wk13_22 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk14_22 <- wk14_22 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk15_22 <- wk15_22 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk16_22 <- wk16_22 %>% filter(position=="TE") %>% select(-c(team, games, position))
wk17_22 <- wk17_22 %>% filter(position=="TE") %>% select(-c(team, games, position))
```

# Data Transformation
```{r}
total_23 <- select(total_23, c(player, fantasyPts))
total_22 <- select(total_22, c(player, fantasyPts))
```

```{r}
big_23 <- rbind(wk1_23,wk2_23,wk3_23,wk4_23,wk5_23,wk6_23,wk7_23,wk8_23,wk9_23,wk10_23,wk11_23,wk12_23,wk13_23,wk14_23,wk15_23,wk16_23,wk17_23)
big_23 <- merge(big_23, total_23, by="player", all=T, suffixes=c(".x", ".y"))

big_22 <- rbind(wk1_22,wk2_22,wk3_22,wk4_22,wk5_22,wk6_22,wk7_22,wk8_22,wk9_22,wk10_22,wk11_22,wk12_22,wk13_22,wk14_22,wk15_22,wk16_22,wk17_22)
big_22 <- merge(big_22, total_22, by="player", all=T, suffixes=c(".x", ".y"))
```

```{r}
big_association <- rbind(big_23, big_22)
big_association <- big_association %>% 
  select(-c(player)) %>%
  na.omit()
big_association <- subset(big_association, recTarg>0)
glimpse(big_association)
```

Pairing adjacent weeks and respective players' stats are averaged
```{r}
weeks_pair1_23 <- rbind(wk1_23, wk2_23) %>%
  group_by(player) %>%
  summarise(across( .fns=mean))
weeks_pair2_23 <- rbind(wk2_23, wk3_23) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair3_23 <- rbind(wk3_23, wk4_23) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair4_23 <- rbind(wk4_23, wk5_23) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair5_23 <- rbind(wk5_23, wk6_23) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair6_23 <- rbind(wk6_23, wk7_23) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair7_23 <- rbind(wk7_23, wk8_23) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair8_23 <- rbind(wk8_23, wk9_23) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair9_23 <- rbind(wk9_23, wk10_23) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair10_23 <- rbind(wk10_23, wk11_23) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair11_23 <- rbind(wk11_23, wk12_23) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair12_23 <- rbind(wk12_23, wk13_23) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair13_23 <- rbind(wk13_23, wk14_23) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair14_23 <- rbind(wk14_23, wk15_23) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair15_23 <- rbind(wk15_23, wk16_23) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair16_23 <- rbind(wk16_23, wk17_23) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
```

```{r}
weeks_pair1_22 <- rbind(wk1_22, wk2_22) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair2_22 <- rbind(wk2_22, wk3_22) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair3_22 <- rbind(wk3_22, wk4_22) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair4_22 <- rbind(wk4_22, wk5_22) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair5_22 <- rbind(wk5_22, wk6_22) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair6_22 <- rbind(wk6_22, wk7_22) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair7_22 <- rbind(wk7_22, wk8_22) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair8_22 <- rbind(wk8_22, wk9_22) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair9_22 <- rbind(wk9_22, wk10_22) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair10_22 <- rbind(wk10_22, wk11_22) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair11_22 <- rbind(wk11_22, wk12_22) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair12_22 <- rbind(wk12_22, wk13_22) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair13_22 <- rbind(wk13_22, wk14_22) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair14_22 <- rbind(wk14_22, wk15_22) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair15_22 <- rbind(wk15_22, wk16_22) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
weeks_pair16_22 <- rbind(wk16_22, wk17_22) %>%
  group_by(player) %>%
  summarise(across(.fns=mean))
```

```{r}
pairs_23 <- rbind(weeks_pair1_23, weeks_pair2_23, weeks_pair3_23, weeks_pair4_23, weeks_pair5_23, weeks_pair6_23, weeks_pair7_23, weeks_pair8_23,
                  weeks_pair9_23, weeks_pair10_23, weeks_pair11_23, weeks_pair12_23, weeks_pair13_23, weeks_pair14_23, weeks_pair15_23,
                  weeks_pair16_23)
pairs_23 <- merge(pairs_23, total_23, by="player", all=T, suffixes=c(".x", ".y"))
pairs_22 <- rbind(weeks_pair1_22, weeks_pair2_22, weeks_pair3_22, weeks_pair4_22, weeks_pair5_22, weeks_pair6_22, weeks_pair7_22, weeks_pair8_22,
                  weeks_pair9_22, weeks_pair10_22, weeks_pair11_22, weeks_pair12_22, weeks_pair13_22, weeks_pair14_22, weeks_pair15_22,
                  weeks_pair16_22)
pairs_22 <- merge(pairs_22, total_22, by="player", all=T, suffixes=c(".x", ".y"))
```

```{r}
big_pairs <- rbind(pairs_23, pairs_23)
big_pairs <- big_pairs %>% 
  select(-c(player)) %>%
  na.omit()
glimpse(big_pairs)
```

# Data Analysis

```{r}
colnames <- c(colnames(big_association))
cor.x <- c(round(cor(big_association, big_association$fantasyPts.x, use="complete.obs"), 3))
cor.y <- c(round(cor(big_association, big_association$fantasyPts.y, use="complete.obs"), 3))
coh.x <- c(round(apply(big_association, 2, cohensD, y=big_association$fantasyPts.x), 3))
coh.y <- c(round(apply(big_association, 2, cohensD, y=big_association$fantasyPts.y), 3))
comatrix <- data.frame(colnames=colnames, cor.x=cor.x, cor.y=cor.y, coh.x=coh.x, coh.y=coh.y)
comatrix <- comatrix %>% 
  mutate(effect.x=round(cor.x*coh.x,3)) %>%
  mutate(effect.y=round(cor.y*coh.y,3)) %>%
  mutate(cor.diff=round(cor.y-cor.x,3)) %>%
  mutate(coh.diff=round(coh.y-coh.x,3)) %>%
  mutate(effect.diff=round(effect.y-effect.x,3))
arrange(comatrix, desc(cor.x))
```

Calculating the coefficient of variation for each variable over all weeks.
```{r}
cv <- function(x) {
  m <- mean(x)
  var <- var(x)
  cv <- var/m
  return(cv)
}
```

```{r}
var.x <- as.matrix(round(apply(big_association[,cor.x.index], 2, cv), 3))
var.y <- as.matrix(round(apply(big_association[,cor.y.index], 2, cv), 3))
var.x.stable.index <- which(var.x<20)
var.x.unstable.index <- which(var.x>20)
var.y.stable.index <- which(var.y<20)
var.y.unstable.index <- which(var.y>20)
head(var.x, 20)
```

```{r}
data <- big_association %>% 
  select(c(recRec, recYds, recTds, fantasyPts.x)) %>% 
  na.omit()
all <- lm(fantasyPts.x ~ ., data=data)
model <- step(all, direction = "backward", trace=0)
summary(model)
```

```{r}
data <- big_association %>% 
  select(-c(recRec, recYds, recTds, fantasyPts.y)) %>% 
  na.omit()
all <- lm(fantasyPts.x ~ ., data=data)
model <- step(all, direction = "backward", trace=0)
summary(model)
```

```{r}
data <- big_association %>% 
  select(-c(recRec, recYds, recTds, recRec40s, recYds100Games, recTd40s, rzRecRec, rzRecTds, ezRecTds, rushYds, rushTds, fantasyPts.y)) %>% 
  na.omit()
all <- lm(fantasyPts.x ~ ., data=data)
model <- step(all, direction = "backward", trace=0)
summary(model)
```

```{r}
data <- big_association %>% 
  select(c(recTarg, catch, rzRecTarg, rzRecTdPct, ptsPerTouch, fantasyPts.x)) %>% 
  na.omit()
all <- lm(fantasyPts.x ~ ., data=data)
model <- step(all, direction = "backward", trace=0)
summary(model)
```

# Data Visualization

Visualizing Stability
```{r}
#ggplot()
#geom_smooth()
theme_TE <- theme(text=element_text(family="Times New Roman"))
ggplot(big_association, aes(x=recTd40s)) +
  geom_histogram(binwidth=sd(big_association$recTd40s)/2, fill="darkorchid4") +
  labs(title="Distribution of Receiving Touchdowns over 40 Yards (Stable) (TE)", x="Receiving TDs over 40yds within Game", y="")

ggplot(big_association, aes(x=recRec)) +
  geom_histogram(binwidth=sd(big_association$recRec)/2, fill="darkorchid4") +
  labs(title="Distribution of Receiving Receptions (Stable) (TE)", x="Receiving Recs within Game", y="")
      
ggplot(big_association, aes(x=recYds)) +
  geom_histogram(binwidth=sd(big_association$recYds)/2, fill="darkorchid4") +
  labs(title="Distribution of Receiving Yards (Unstable) (TE)", x="Receiving Yards within Game", y="")

ggplot(big_association, aes(x=rzRecTargPct)) +
  geom_histogram(binwidth=sd(big_association$rzRecTargPct)/2, fill="darkorchid4") +
  labs(title="Distribution of Redzone Target% (Unstable) (TE)", x="Receiving Redzone Target% within Game", y="")

```

```{r}
data <- big_association %>%
  select(c(recTarg, catch, rzRecTarg, rzRecTdPct, ptsPerTouch, fantasyPts.x))
plot <- cor(data)
corrplot(plot, method = 'color', order = 'AOE', diag = FALSE)
```

```{r}
ggplot(subset(big_association, recTds<3), aes(x=factor(recTds), y=fantasyPts.x)) +
  geom_violin(fill="darkorchid4") +
  labs(title="Receiving Tds and Fantasy Points (TE)", x="Receiving Touchdowns within game", y="Fantasy Points within game")

ggplot(big_association, aes(x=catch, y=fantasyPts.x)) +
  geom_smooth(data=subset(big_association, recTarg>1), method="loess", se=F, color="violet") +
  geom_smooth(data=subset(big_association, recTarg>3), method="loess", se=F, color="darkorchid2") +
  geom_smooth(data=subset(big_association, recTarg>5), method="loess", se=F, color="darkorchid3") +
  geom_smooth(data=subset(big_association, recTarg>7), method="loess", se=F, color="darkorchid4") +
  labs(title="Catch Percentage and Fantasy Points (TE)", x="Catch Percentage within a game for varying Targets>(1,3,5,7)", y="Fantasy Points within a game")
```

```{r}
ggplot(big_association, aes(x=factor(recTarg), y=fantasyPts.y)) +
  geom_boxplot(fill="darkorchid4") +
  labs(title="Year-End Points by Receiving Targets within a single game (TE)", x="Targets within game", y="Year-End Fantasy Points")

ggplot(big_association, aes(x=factor(recRec), y=fantasyPts.y)) +
  geom_boxplot(fill="darkorchid4") +
  labs(title="Year-End Points by Receptions within a single game (TE)", x="Receptions within game", y="Year-End Fantasy Points")

ggplot(big_association, aes(x=factor(rzRecTarg), y=fantasyPts.y)) +
  geom_boxplot(fill="darkorchid4") +
  labs(title="Year-End Points by Redzone Receiving Targets within a single game (TE)", x="Redzone Targets within game", y="Year-End Fantasy Points")

ggplot(big_association, aes(x=factor(rzRecRec), y=fantasyPts.y)) +
  geom_boxplot(fill="darkorchid4") +
  labs(title="Year-End Points by Redzone Receptions within a single game (TE)", x="Redzone Recpetions within game", y="Year-End Fantasy Points")
```

```{r}
ggplot(big_association, aes(x=recYds, y=fantasyPts.y, size=recTds, alpha=.4)) +
  geom_point() +
  scale_size(range=c(1,3)) +
  labs(title="Year-End Points by Receiving Yards within a single game (TE)", x="Receiving Yards per game", y="Year-End Fantasy Points")
```


#Data Prediction

```{r}
data <- big_association %>% 
  select(-c(fantasyPts.x)) %>% 
  na.omit()
all <- lm(fantasyPts.y ~ ., data=data)
model <- step(all, direction = "backward", trace=0)
summary(model)
```

```{r}
data <- big_association %>% 
  select(c(recRec, recYds, recTds, fantasyPts.y)) %>% 
  na.omit()
all <- lm(fantasyPts.y ~ ., data=data)
model <- step(all, direction = "backward", trace=0)
summary(model)
```

```{r}
data <- big_pairs %>% 
  select(-c(fantasyPts.x)) %>% 
  na.omit()
all <- lm(fantasyPts.y ~ ., data=data)
model <- step(all, direction = "backward", trace=0)
summary(model)
```

```{r}
data <- big_pairs %>% 
  select(c(recRec, recYds, recTds, fantasyPts.y)) %>% 
  na.omit()
all <- lm(fantasyPts.y ~ ., data=data)
model <- step(all, direction = "backward", trace=0)
summary(model)
```

```{r}
ggplot(big_pairs, aes(x=factor(recTarg), y=fantasyPts.y)) +
  geom_boxplot(fill="darkorchid4") +
  labs(title="Year-End Points by Receiving Targets consecutive games (TE)", x="Targets in consecutive games", y="Year-End Fantasy Points")

ggplot(big_pairs, aes(x=factor(recRec), y=fantasyPts.y)) +
  geom_boxplot(fill="darkorchid4") +
  labs(title="Year-End Points by Receptions within a single game (TE)", x="Receptions within game", y="Year-End Fantasy Points")
```

```{r}

```

